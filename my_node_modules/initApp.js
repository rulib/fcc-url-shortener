var exports = module.exports = {};
var MongoClient = require('mongodb').MongoClient;
var collection = 'urls';
var counterID = "";

exports.initialize = function (url, collection, callback){
    MongoClient.connect(url, function(err, db) {
        if (err) throw err;
        var coll = db.collection(collection);
        coll.find(
          {
          "counterValue":{$exists:true}
          },{
        counterValue:1
      }).toArray(function (err, result){
          if (err){console.log(err)}
          else if (result.length>0){
              //load the id of the counter
              console.log("Found counter at ID: " + result[0]["_id"]);
              var output = result[0]["_id"];
              db.close();
              console.log("passing (1) "+output);
              return callback(output);
              
          } else {
              //create a new counter and load the ID of the new counter
              var insertable = {type:"counter", counterValue : 10000};
              coll.insert(insertable, function(err,inserted){
                  if (err) throw err;
                  console.log(inserted["insertedIds"][0]);
                  var output2 = inserted["insertedIds"][0];
                  db.close();
                  console.log("passing (2) "+output2);
                  return callback(output2);
              });
              
          }
          
        
        
    });

    
    
});
};
